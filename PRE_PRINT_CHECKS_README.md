# Additional Pre-Print Checks Plugin

A Moonraker plugin that validates filament spool data against gcode metadata before printing.

## Features

- **Weight Check**: Verifies sufficient filament weight is available
- **Material Check**: Validates spool material matches gcode requirements
- **Filament Name Check**: Ensures correct filament profile is loaded
- **Configurable Severity**: Set each check to error, warning, or info level
- **Spool Caching**: Efficient single fetch per check session

## Configuration

Add to `moonraker.conf`:

```ini
[additional_pre_print_checks]
# Enable/disable individual checks
enable_weight_check: True
enable_material_check: True
enable_filament_name_check: False

# Weight check configuration
weight_margin_grams: 5.0

# Mismatch severity levels: 'error', 'warning', 'info', 'ignore'
# 'error' = block print, 'warning' = warn but allow, 'info' = log only
material_mismatch_severity: warning
filament_name_mismatch_severity: info
```

## Remote Methods

### `pre_print_check_weight`
Check if active spool has sufficient weight for the print.

```gcode
{% set weight_ok = action_call_remote_method("pre_print_check_weight", filename=printer.print_stats.filename) %}
```

### `pre_print_check_all`
Run all enabled checks in one call (recommended).

```gcode
{% set all_checks_ok = action_call_remote_method("pre_print_check_all", filename=printer.print_stats.filename) %}
```

## Usage Example

Add to your `START_PRINT` macro:

```gcode
[gcode_macro START_PRINT]
gcode:
    # Get filename
    {% set filename = printer.print_stats.filename %}

    # Run all pre-print checks
    {% set checks_ok = action_call_remote_method("pre_print_check_all", filename=filename) %}

    {% if not checks_ok %}
        M117 Pre-print checks failed!
        CANCEL_PRINT
    {% endif %}

    # Continue with normal print start sequence...
    M117 Starting print
    G28  # Home
    # ... rest of your start sequence
```

## Check Behavior

### Weight Check
- Reads `filament_weight_total` from gcode metadata
- Compares against `remaining_weight` in active Spoolman spool
- Adds configurable safety margin
- **Blocks** if insufficient weight (always error severity)

### Material Check
- Reads `filament_type` from gcode metadata (first entry)
- Compares against spool's `material` field (case-insensitive)
- Severity configurable: error, warning, info, or ignore

### Filament Name Check
- Reads `filament_name` from gcode metadata (first entry)
- Compares against spool's `name` field (case-insensitive)
- Severity configurable: error, warning, info, or ignore
- Useful for ensuring correct vendor/profile loaded

## Requirements

- Moonraker with Spoolman component configured
- Active spool set in Spoolman
- Gcode files with proper slicer metadata

## Metadata Requirements

The plugin reads standard metadata fields generated by most slicers:
- `filament_weight_total` (PrusaSlicer, OrcaSlicer, Bambu Studio, etc.)
- `filament_type` (material names as array)
- `filament_name` (filament profile names as array)

If metadata is missing, the respective check is skipped gracefully.

## Severity Levels

| Level | Behavior |
|-------|----------|
| `error` | Blocks print, returns False |
| `warning` | Logs warning, allows print, returns True |
| `info` | Logs info message, allows print, returns True |
| `ignore` | Skips check entirely |

## Logging

All checks log to:
- Moonraker log (`moonraker.log`)
- Klipper console (via M118)

Messages indicate:
- Check results (PASSED/FAILED)
- Spool ID and filament name
- Expected vs actual values
- Deficit amounts (for weight check)
