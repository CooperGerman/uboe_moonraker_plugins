# Additional Pre-Print Checks Plugin

A Moonraker plugin that validates filament spool data against gcode metadata before printing.

## Features

- **Weight Check**: Verifies sufficient filament weight is available
- **Material Check**: Validates spool material matches gcode requirements
- **Filament Name Check**: Ensures correct filament profile is loaded
- **Configurable Severity**: Set each check to error, warning, or info level
- **Spool Caching**: Efficient single fetch per check session

## Configuration

Add to `moonraker.conf`:

```ini
[additional_pre_print_checks]
# Enable/disable individual checks
enable_weight_check: True
enable_material_check: True
enable_filament_name_check: False

# Weight check configuration
weight_margin_grams: 5.0

# Mismatch severity levels: 'error', 'warning', 'info', 'ignore'
# 'error' = block print, 'warning' = warn but allow, 'info' = log only
material_mismatch_severity: warning
filament_name_mismatch_severity: info
```

## Remote Methods

### `pre_print_checks`
Run all enabled pre-print checks on the current print file.

- Automatically retrieves the current filename from Klipper
- Pauses the print if any check fails with error severity
- No parameters or return values needed

```gcode
{ action_call_remote_method("pre_print_checks") }
```

## Usage Example

Add to your `START_PRINT` macro:

```gcode
[gcode_macro START_PRINT]
gcode:
    # Run all pre-print checks
    # Plugin will automatically pause print if checks fail
    { action_call_remote_method("pre_print_checks") }

    # Continue with normal print start sequence
    M117 Starting print
    G28  # Home
    # ... rest of your start sequence
```

**Note:** The plugin automatically:
- Retrieves the current filename from Klipper's print_stats
- Runs all enabled checks
- Pauses the print if any check fails with error severity
- Logs all results to console and moonraker.log
- **Always error severity** - pauses print if insufficient weight

### Material Check
- Reads `filament_type` from gcode metadata (first entry)
- Compares against spool's `material` field (case-insensitive)
- Severity configurable: error (pause), warning, info, or ignore

### Filament Name Check
- Reads `filament_name` from gcode metadata (first entry)
- Compares against spool's `name` field (case-insensitive)
- Severity configurable: error (pause), warning, info, or ignore
- Useful for ensuring correct vendor/profile loaded

**Automatic Actions:**
- All checks run automatically when `pre_print_checks` is called
- Print is paused if any check fails with error severity
- Warnings and info messages are logged but don't block the print

## Metadata Requirements

The plugin reads standard metadata fields generated by most slicers:
- `filament_weight_total` (PrusaSlicer, OrcaSlicer, Bambu Studio, etc.)
- `filament_type` (material names as array)
- `filament_name` (filament profile names as array)

If metadata is missing, the respective check is skipped gracefully.

## Severity Levels

| Level | Behavior |
|-------|----------|
| `error` | Pauses print immediately, logs error message |
| `warning` | Logs warning message, allows print to continue |
| `info` | Logs info message, allows print to continue |
| `ignore` | Skips check entirely |

## Logging

All checks log to:
- Moonraker log (`moonraker.log`)
- Klipper console (via M118)

Messages indicate:
- Check results (PASSED/FAILED)
- Spool ID and filament name
- Expected vs actual values
- Deficit amounts (for weight check)
